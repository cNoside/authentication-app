name: ðŸš€ Deploy to VPS

on:
  push:
    branches: [main]

jobs:
  deploy:
    name: ðŸš€ Deploy to VPS

    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“š Checkout
        uses: actions/checkout@v2

      - name: ðŸ“§ Copy files to VPS
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          port: ${{ secrets.PORT }}
          key: ${{ secrets.KEY }}
          passphrase: ${{ secrets.PASSPHRASE }}
          source: '.'
          target: '/var/www/vhosts/authentication-app'

      - name: ðŸ”¥ Start The App
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          port: ${{ secrets.PORT }}
          key: ${{ secrets.KEY }}
          passphrase: ${{ secrets.PASSPHRASE }}
          script: |
            . ~/.profile
            export NVM_DIR=~/.nvm
            source ~/.nvm/nvm.sh
            exec $SHELL
            echo $SERVER_URL
            echo $CLIENT_URL
            echo $PATH
            cd /var/www/vhosts/authentication-app
            pm2 stop authentication-app
            pm2 delete authentication-app
            pnpm install --frozen-lockfile
            pm2 start "pnpm prod" --name authentication-app
